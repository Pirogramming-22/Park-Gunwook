{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'reset.css' %}">
    <link rel="stylesheet" href="{% static 'layout.css' %}">
    <link rel="stylesheet" href="{% static 'header.css' %}">
    <link rel="stylesheet" href="{% static 'profile.css' %}">
    <link rel="stylesheet" href="{% static 'userInfo.css' %}">
    <link rel="stylesheet" href="{% static 'highlights.css' %}">
    <link rel="stylesheet" href="{% static 'posts.css' %}">
    <title>Profile Page</title>
</head>
<body>
<div class="container">
    <header class="header">
        <button class="header__goBackButton">
            <img src="{% static 'assets/icons/goBack.svg' %}" alt="ë’¤ë¡œ ê°€ê¸° ë²„íŠ¼">
        </button>
        <div class="header__username">Pirogramming</div>
        <div class="header__rightButtons">
            <button class="header__alarmButton">
                <img src="{% static 'assets/icons/alarm.svg' %}" alt="ì•Œë¦¼ ì—´ê¸° ë²„íŠ¼">
            </button>
            <button class="header__moreButton">
                <img src="{% static 'assets/icons/more.svg' %}" alt="ë”ë³´ê¸° ì—´ê¸° ë²„íŠ¼">
            </button>
        </div>
    </header>
    <main>
        <section class="profile">
            <div class="profile__image">
                <img src="{% static 'assets/images/profilePicture.png' %}" alt="í”„ë¡œí•„ ì‚¬ì§„">
            </div>
            <div class="profile__data">
                <div class="profile__data-item">
                    <div class="profile__data-number">1,234</div>
                    <div class="profile__data-type">Posts</div>
                </div>
                <div class="profile__data-item">
                    <div class="profile__data-number">5,678</div>
                    <div class="profile__data-type">Followers</div>
                </div>
                <div class="profile__data-item">
                    <div class="profile__data-number">9,101</div>
                    <div class="profile__data-type">Following</div>
                </div>
            </div>
        </section>
        <section class="userInfo">
            <div>
                <div class="userInfo__username">Pirogramming</div>
                <div class="userInfo__category">ì»´í“¨í„° íšŒì‚¬</div>
                <div class="userInfo__description">
                    í”„ë¡œê·¸ë˜ë°ì˜ ì²« ê±¸ìŒ, í”¼ë¡œê·¸ë˜ë°
                </div>
            </div>
            <button class="userInfo__follow">Follow</button>
        </section>
        <aside class="highlights">
            <div class="highlights__item">
                <button class="highlights__item-image">
                    <img src="{% static 'assets/images/profilePicture.png' %}" alt="í•˜ì´ë¼ì´íŠ¸ ë³´ê¸°">
                </button>
                <div class="highlights_item-title">Title</div>
            </div>
        </aside>
        <section class="posts">
            <nav class="posts__tabBar">
                <div class="posts__tab posts__tab--selected">1</div>
                <div class="posts__tab">2</div>
                <div class="posts__tab">3</div>
            </nav>
            <article class="posts__contents">
                {% for post in posts %}
                <div class="posts__photo">
                    <img src="{{ post.image.url }}" alt="í¬ìŠ¤íŠ¸ ì´ë¯¸ì§€">
            
                    <!-- ì¢‹ì•„ìš” ë²„íŠ¼ ì¶”ê°€ -->
                    <form method="POST" action="{% url 'instagram:toggle_like' post.id %}" data-post-id="{{ post.id }}">
                        {% csrf_token %}
                        <button type="submit" class="posts__likeButton">
                            {% if likes_count == 1 %}
                                ğŸ’” <span class="like_color">Unlike</span>
                            {% else %}
                                â¤ï¸ <span class="like_color">Like</span>
                            {% endif %}
                        </button>
                    </form>
            
                    <!-- ëŒ“ê¸€ ì…ë ¥ í¼ ì¶”ê°€ -->
                    <div class="posts__comments">
                        <!-- ëŒ“ê¸€ ëª©ë¡ -->
                        <ul>
                            {% for comment in post.comments.all %}
                            <li id="comment-{{ comment.id }}">
                                {{ comment.content }}
                                <button class="posts__deleteCommentButton" data-comment-id="{{ comment.id }}">ì‚­ì œ</button>
                            </li>
                            {% endfor %}
                        </ul>
            
                        <!-- ëŒ“ê¸€ ì…ë ¥ í¼ -->
                        <form class="posts__commentForm" method="POST" data-post-id="{{ post.id }}">
                            {% csrf_token %}
                            <textarea name="comment" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                            <button type="submit" class="posts__commentButton">ëŒ“ê¸€ ë‹¬ê¸°</button>
                        </form>
                    </div>
                </div>
                {% empty %}
                <p>No posts available.</p>
                {% endfor %}
            </article>
        </section>
    </main>
</div>
</body>
<script>
    // ì¢‹ì•„ìš” ë²„íŠ¼ í´ë¦­ ì‹œ AJAX ìš”ì²­ ì²˜ë¦¬
    document.addEventListener('DOMContentLoaded', function () {
        const likeButtons = document.querySelectorAll('.posts__likeButton');
    
        likeButtons.forEach(button => {
            const form = button.closest('form');
            const postId = form.dataset.postId;
    
            if (!postId) {
                console.error("Post ID is missing!");
                return;
            }
            console.log(postId);
            // í˜ì´ì§€ ë¡œë“œ ì‹œ ì„œë²„ì—ì„œ í˜„ì¬ ì¢‹ì•„ìš” ìƒíƒœ í™•ì¸
            fetch(`/post/${postId}/like/`)
                .then(response => response.json())
                .then(data => {
                    // ì„œë²„ì—ì„œ ë°›ì€ ìƒíƒœì— ë§ê²Œ ì´ˆê¸°í™”
                    if (data.likes_count === 1) {
                        button.innerHTML = 'ğŸ’” <span class="like_color">Unlike</span>';
                        console.log(data.likes_count);
                    } else {
                        button.innerHTML = 'â¤ï¸ <span class="like_color">Like</span>';
                        console.log(data.likes_count);
                    }
                })
                .catch(error => console.error('Error:', error));
    
            button.addEventListener('click', function (event) {
                event.preventDefault(); // ê¸°ë³¸ í¼ ì œì¶œì„ ë§‰ìŒ
    
                // AJAX ìš”ì²­ ë³´ë‚´ê¸°
                fetch(`/post/${postId}/like/`, {
                    method: 'POST',
                    body: new FormData(form),
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value // CSRF í† í° í—¤ë”ì— ì¶”ê°€
                    }
                })
                .then(response => response.json())
                .then(data => {
                    console.log(data.likes_count)
                    // ì¢‹ì•„ìš” ìƒíƒœì— ë§ê²Œ ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
                    if (data.likes_count === 1) {
                        button.innerHTML = 'ğŸ’” <span class="like_color">Unlike</span>';
                        console.log("TRUE");
                    } else {
                        button.innerHTML = 'â¤ï¸ <span class="like_color">Like</span>';
                    }
                })
                .catch(error => console.error('Error:', error));
            });
        });
    });
    
    document.addEventListener('DOMContentLoaded', function() {
        const commentForms = document.querySelectorAll('.posts__commentForm');

        commentForms.forEach(form => {
            form.addEventListener('submit', function(event) {
                event.preventDefault(); // ê¸°ë³¸ í¼ ì œì¶œ ë°©ì§€

                const postId = form.dataset.postId; // data-post-id ì†ì„±ì—ì„œ í¬ìŠ¤íŠ¸ ID ê°€ì ¸ì˜¤ê¸°
                const content = form.querySelector('textarea[name="comment"]').value; // ëŒ“ê¸€ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
                const csrfToken = form.querySelector('input[name="csrfmiddlewaretoken"]').value; // CSRF í† í° ê°€ì ¸ì˜¤ê¸°

                // XMLHttpRequest ê°ì²´ ìƒì„±
                const xhr = new XMLHttpRequest();
                xhr.open('POST', '/instagram/post/' + postId + '/add-comment/', true);
                xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                xhr.setRequestHeader('X-CSRFToken', csrfToken);  // CSRF í† í° ì„¤ì •

                // AJAX ìš”ì²­ì„ ë³´ëƒ„
                xhr.onload = function() {
                    if (xhr.status === 200) {
                        const response = JSON.parse(xhr.responseText);
                        
                        // ìƒˆë¡œìš´ ëŒ“ê¸€ HTMLì„ ìƒì„±í•˜ì—¬ ëŒ“ê¸€ ëª©ë¡ì— ì¶”ê°€
                        const commentHtml = `
                            <li id="comment-${response.id}">
                                ${response.content}
                                <button class="posts__deleteCommentButton" data-comment-id="${response.id}">ì‚­ì œ</button>
                            </li>
                        `;
                        form.closest('.posts__comments').querySelector('ul').insertAdjacentHTML('beforeend', commentHtml);

                        // ëŒ“ê¸€ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                        form.querySelector('textarea').value = '';

                        // ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                        addDeleteButtonEventListeners();
                    } else {
                        alert('ëŒ“ê¸€ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                };

                // AJAXë¡œ ë³´ë‚´ëŠ” ë°ì´í„°
                const data = `content=${encodeURIComponent(content)}`;

                // ìš”ì²­ ë³´ë‚´ê¸°
                xhr.send(data);
            });
        });

        // ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        function addDeleteButtonEventListeners() {
            const deleteButtons = document.querySelectorAll('.posts__deleteCommentButton');
        
            deleteButtons.forEach(button => {
                button.addEventListener('click', function(event) {
                    event.preventDefault(); // ê¸°ë³¸ ë™ì‘ ë°©ì§€

                    const commentId = button.getAttribute('data-comment-id');
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                    // AJAX ìš”ì²­
                    fetch(`/instagram/comment/${commentId}/delete/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrfToken
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            // ëŒ“ê¸€ ì‚­ì œ í›„ DOMì—ì„œ ëŒ“ê¸€ í•­ëª© ì‚­ì œ
                            document.querySelector(`#comment-${commentId}`).remove();
                        } else {
                            alert('ëŒ“ê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        }
                    })
                    .catch(error => console.error('Error:', error));
                });
            });
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ëŒ“ê¸€ë“¤ì— ëŒ€í•´ì„œë„ ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì¶”ê°€
        addDeleteButtonEventListeners();
    });
</script>
</html>
